#! /usr/bin/env python


import Params, Request, Response, fiber, weakref


DOWNLOADS = weakref.WeakValueDictionary()


def transaction( client, address ):

  print 'Accepted request from %s:%i' % address

  request = Request.HttpRequest()
  while not request.Protocol:
    yield fiber.RECV( client )
    request.recv( client )

  try:

    while request in DOWNLOADS:
      protocol = DOWNLOADS[ request ]
      if not protocol.canjoin():
        del DOWNLOADS[ request ]
        continue
      if protocol.Response:
        print 'Joined running download'
        break
      yield fiber.WAIT()
    else:
      protocol = DOWNLOADS[ request ] = request.Protocol( request )
      server = protocol.getsocket()
      while not protocol.Response:
        if protocol.cansend():
          yield fiber.SEND( server )
          protocol.send( server )
        else:
          yield fiber.RECV( server )
          protocol.recv( server )

    response = protocol.Response( protocol, request )
    server = protocol.getsocket()
  except:
    response = Response.ExceptionResponse()
    server = None

  while not response.Done:
    if response.cansend():
      yield fiber.SEND( client )
      response.send( client )
    elif response.canrecv():
      yield fiber.RECV( server )
      response.recv( server )
    else:
      yield fiber.WAIT( .5 )


fiber.spawn( transaction, Params.PORT, Params.TIMEOUT, Params.DEBUG )
